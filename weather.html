<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- 載入bs5 css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css"
      integrity="sha512-fw7f+TcMjTb7bpbLJZlP8g2Y4XcCyFZW8uy8HsRZsH/SwbMw0plKHFHr99DN3l04VsYNwvzicUX/6qurvIxbxw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- DataTables for Bootstrap 5 -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
    />
    <!-- 移除 DataTables Responsive，改用 Bootstrap 的 .table-responsive -->

    <style></style>
  </head>

  <body>
    <div class="container mt-3">
      <h2>氣象預報 36 小時資料</h2>
      <p></p>
      <div class="table-responsive">
        <table
          id="myTable"
          class="table table-bordered table-striped table-hover align-middle mb-0"
        >
          <thead class="table-light">
            <tr>
              <th>城市</th>
              <th id="thRange1">0–12 小時</th>
              <th id="thRange2">12–24 小時</th>
              <th id="thRange3">24–36 小時</th>
            </tr>
          </thead>
          <tbody id="myTbody">
            <!-- <tr>
                    <td>1</td>
                    <td>新北市</td>
                </tr> -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 載入bs5 js -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js"
      integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- 載入jquery -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- DataTables JS (需在 jQuery 之後) -->
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <!-- 已改用 Bootstrap .table-responsive，無需 DataTables Responsive JS -->

    <!-- 載入pwd -->
    <!-- .gitignore -->
    <!-- /pw -->
    <!-- /pw/pw.js -->
    <!-- let pw = 'your password' -->
    <script src="pw.js"></script>
    <script>
      $(document).ready(function () {
        // 1.bind
        let pwd = pw;
        const myTbody = $("#myTbody");
        // 簡單判斷：startTime 的小時 >=18 或 <6 視為夜間，否則為白天
        const getIconFolder = (startTime) => {
          if (!startTime || startTime.length < 13) return 'day';
          const hh = parseInt(startTime.slice(11, 13), 10);
          return (hh >= 18 || hh < 6) ? 'night' : 'day';
        };

        // 2.action init
        let url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${pwd}`;
        $.ajax({
          type: "get",
          url: url,
          // data: "data",
          dataType: "json",
          success: function (response) {
            // let data = response.records.location[0].locationName;
            let data = response.records.location;

            // let tmpData = data[0].weatherElement[2].time[0].parameter.parameterName;
            // console.log('tmpData', tmpData);

            // 取第一個地點的三段時間當表頭範圍（各地點時間段一致）
            const times = data?.[0]?.weatherElement?.[2]?.time || [];
            // 不轉換，直接顯示原始時間字串
            const getRangeText = (t) =>
              t ? `${t.startTime}–${t.endTime}` : "";
            $("#thRange1").text(getRangeText(times[0]) || "區間 1");
            $("#thRange2").text(getRangeText(times[1]) || "區間 2");
            $("#thRange3").text(getRangeText(times[2]) || "區間 3");

            let tmpText = ``;

            $.each(data, function (key, value) {
              // wx
              let wxT12 =
                value.weatherElement[0].time[0].parameter.parameterName;
              let wxT24 =
                value.weatherElement[0].time[1].parameter.parameterName;
              let wxT36 =
                value.weatherElement[0].time[2].parameter.parameterName;

              // 各段開始時間（用於判斷 day/night）
              const start12 = value.weatherElement[0].time[0].startTime;
              const start24 = value.weatherElement[0].time[1].startTime;
              const start36 = value.weatherElement[0].time[2].startTime;
              const folder12 = getIconFolder(start12);
              const folder24 = getIconFolder(start24);
              const folder36 = getIconFolder(start36);

              // wxValue
              let wxValue12 =
                value.weatherElement[0].time[0].parameter.parameterValue;
              let wxValue24 =
                value.weatherElement[0].time[1].parameter.parameterValue;
              let wxValue36 =
                value.weatherElement[0].time[2].parameter.parameterValue;

              // minT
              let minT12 =
                value.weatherElement[2].time[0].parameter.parameterName;
              let minT24 =
                value.weatherElement[2].time[1].parameter.parameterName;
              let minT36 =
                value.weatherElement[2].time[2].parameter.parameterName;

              // maxT
              let maxT12 =
                value.weatherElement[4].time[0].parameter.parameterName;
              let maxT24 =
                value.weatherElement[4].time[1].parameter.parameterName;
              let maxT36 =
                value.weatherElement[4].time[2].parameter.parameterName;

              tmpText += `
                            <tr>
                                <td>${value.locationName}</td>
                                <td>${minT12}-${maxT12} &deg;C ${wxT12} <img src="./${folder12}/${wxValue12}.svg" alt=""></td>
                                <td>${minT24}-${maxT24} &deg;C ${wxT24} <img src="./${folder24}/${wxValue24}.svg" alt=""></td>
                                <td>${minT36}-${maxT36} &deg;C ${wxT36} <img src="./${folder36}/${wxValue36}.svg" alt=""></td>
                            </tr>
                        `;
              // console.log('key', key);
              // console.log('value', value.locationName);
            });

            myTbody.append(tmpText);

            // 初始化 DataTables（繁中介面；無按鈕、無 JS 響應式）
            const dt = $("#myTable").DataTable({
              language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/zh-HANT.json",
              },
              pageLength: 25,
              lengthMenu: [10, 25, 50, 100],
              order: [[0, "asc"]],
              deferRender: true,
              dom: "frtip",
            });
          },
        });
      });
    </script>
  </body>
</html>

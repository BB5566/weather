<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°ç£å¤©æ°£é å ± 36 å°æ™‚ - Weather Taiwan</title>
    <!-- è¼‰å…¥bs5 css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css"
      integrity="sha512-fw7f+TcMjTb7bpbLJZlP8g2Y4XcCyFZW8uy8HsRZsH/SwbMw0plKHFHr99DN3l04VsYNwvzicUX/6qurvIxbxw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- DataTables for Bootstrap 5 -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
    />

    <!-- ç¾ä»£å­—é«”ï¼ˆNoto Sans TCï¼‰æå‡ä¸­æ–‡å­—é«”è³ªæ„Ÿ -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root{
        --brand-primary: #1976D2;
        --brand-accent: #E53935;
        --muted: #6c757d;
        --card-shadow: 0 6px 18px rgba(16,24,40,0.06);
        --gradient-warm: linear-gradient(135deg, #FF9800 0%, #F44336 100%);
        --gradient-cool: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%);
      }
      body {
        font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial,
          "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
          "Noto Color Emoji", sans-serif;
        background: linear-gradient(180deg, #f0f4f8 0%, #e8ecf1 100%);
        min-height: 100vh;
      }
      /* Header Hero */
      .weather-hero {
        background: var(--gradient-cool);
        color: white;
        padding: 2rem 0;
        margin-bottom: 1.5rem;
        border-radius: 0 0 24px 24px;
        text-align: center;
      }
      .weather-hero h1 {
        font-weight: 700;
        margin-bottom: 0.5rem;
      }
      .weather-hero p {
        opacity: 0.9;
        margin-bottom: 0;
      }
      /* KPI cards */
      .kpi-row { display:flex; gap:12px; margin-bottom:16px; padding: 0 8px; }
      .kpi {
        flex:1;
        padding:16px;
        border-radius:12px;
        background:#fff;
        box-shadow:var(--card-shadow);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        text-align: center;
      }
      .kpi:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(16,24,40,0.1);
      }
      .kpi .value { font-size:1.5rem; font-weight:700; color:var(--brand-primary); }
      .kpi .label { font-size:0.85rem; color:var(--muted); margin-top: 4px; }
      .kpi#kpiHigh .value { color: #F44336; }
      .kpi#kpiLow .value { color: #2196F3; }
      /* mini chart visuals */
      canvas[id^="miniChart-"]{ cursor:pointer; display:block; border-radius: 6px; }
      canvas[id^="miniChart-"]:hover { background: rgba(25,118,210,0.05); }
      canvas[id^="miniChart-"]:focus{ outline:3px solid rgba(25,118,210,0.12); }
      /* responsive: on small screens hide table and show card list */
      .card-list { display:none; gap:12px; padding: 0 8px; }
      @media (max-width: 768px) {
        .table-responsive { display:none !important; }
        .card-list { display:flex; flex-direction:column; }
        .kpi-row { flex-wrap: wrap; }
        .kpi { min-width: calc(50% - 6px); flex: 1 1 calc(50% - 6px); }
        .weather-hero { border-radius: 0 0 16px 16px; padding: 1.5rem 1rem; }
        .weather-hero h1 { font-size: 1.5rem; }
      }
      .weather-icon {
        width: 28px;
        height: 28px;
        vertical-align: text-bottom;
      }
      .temp-range {
        font-weight: 600;
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        color: #1565C0;
        font-size: 0.95rem;
      }
      /* é»æ€§è¡¨é ­èˆ‡ç¬¬ä¸€æ¬„ï¼ˆæ–¼ .table-responsive å®¹å™¨å…§ç”Ÿæ•ˆï¼‰ */
      .table-responsive thead th.sticky-top {
        position: sticky;
        top: 0;
        z-index: 5;
        background: var(--bs-body-bg);
      }
      .table-responsive thead th.sticky-col,
      .table-responsive tbody td.sticky-col {
        position: sticky;
        left: 0;
        z-index: 3;
        background: var(--bs-body-bg);
        font-weight: 600;
      }
      .table-responsive thead th.sticky-col {
        z-index: 6;
      }
      /* Card Improvements */
      .card {
        border: none;
        border-radius: 16px;
        overflow: hidden;
      }
      .card-header {
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 1rem 1.25rem;
      }
      /* Chart Container */
      #tempChart {
        max-height: 250px;
      }
      /* Quick City Buttons */
      #quickCityButtons .btn {
        border-radius: 20px;
        font-size: 0.85rem;
        padding: 0.35rem 0.8rem;
      }
      /* Loading State */
      #loading {
        padding: 2rem;
        text-align: center;
      }
      /* Footer */
      .weather-footer {
        text-align: center;
        padding: 1.5rem;
        color: var(--muted);
        font-size: 0.85rem;
      }
      .weather-footer a {
        color: var(--brand-primary);
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <!-- Hero Section -->
    <div class="weather-hero">
      <div class="container">
        <h1>ğŸŒ¤ï¸ å°ç£å¤©æ°£é å ±</h1>
        <p>36 å°æ™‚å¤©æ°£è³‡æ–™ Â· ä¸­å¤®æ°£è±¡ç½²é–‹æ”¾è³‡æ–™</p>
      </div>
    </div>

    <div class="container">
      <!-- ç°¡æ½”åŸå¸‚é¸æ“‡ï¼šåœ°å€ + åŸå¸‚ + å¿«é€ŸæŒ‰éˆ• -->
      <div class="mb-3 d-flex align-items-center gap-2">
        <label for="regionSelect" class="form-label visually-hidden"
          >åœ°å€</label
        >
        <select id="regionSelect" class="form-select form-select-sm w-auto">
          <option value="">å…¨éƒ¨åœ°å€</option>
          <option value="north">åŒ—éƒ¨</option>
          <option value="central">ä¸­éƒ¨</option>
          <option value="south">å—éƒ¨</option>
          <option value="east">æ±éƒ¨</option>
          <option value="islands">é›¢å³¶</option>
        </select>

        <label for="citySelect" class="form-label visually-hidden">åŸå¸‚</label>
        <select id="citySelect" class="form-select form-select-sm w-auto">
          <option value="">å…¨éƒ¨åŸå¸‚</option>
        </select>

        <div id="quickCityButtons" class="ms-3"></div>
      </div>
      <div class="card shadow-sm border-0">
        <div
          class="card-header bg-body-tertiary d-flex align-items-center justify-content-between"
        >
          <h2 class="h5 mb-0">æ°£è±¡é å ± 36 å°æ™‚è³‡æ–™</h2>
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted small"
              >æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdated">â€”</span></span
            >
            <button id="btnReload" class="btn btn-sm btn-primary">
              æ›´æ–°è³‡æ–™
            </button>
          </div>
        </div>
        <!-- KPI summary -->
        <div class="kpi-row">
          <div class="kpi" id="kpiAvg">
            <div class="value" id="kpiAvgValue">â€” Â°C</div>
            <div class="label">å…¨å°å¹³å‡æº«åº¦</div>
          </div>
          <div class="kpi" id="kpiHigh">
            <div class="value" id="kpiHighValue">â€” Â°C</div>
            <div class="label">ä»Šæ—¥æœ€é«˜</div>
          </div>
          <div class="kpi" id="kpiLow">
            <div class="value" id="kpiLowValue">â€” Â°C</div>
            <div class="label">ä»Šæ—¥æœ€ä½</div>
          </div>
        </div>
        <!-- è¡Œå‹•ç‰ˆå¡ç‰‡åˆ—è¡¨ï¼ˆçª„è¢å¹•é¡¯ç¤ºï¼‰ -->
        <div class="card-list" id="cardList"></div>

        <div class="card-body">
          <div id="loading" class="d-none text-muted small mb-2">
            <div
              class="spinner-border spinner-border-sm text-primary"
              role="status"
            ></div>
            <span class="ms-2">è¼‰å…¥ä¸­â€¦</span>
          </div>
          <!-- æº«åº¦èµ°å‹¢åœ–ï¼ˆChart.jsï¼‰ -->
          <div class="mb-4">
            <canvas id="tempChart" height="120" aria-label="æº«åº¦èµ°å‹¢åœ–" role="img"></canvas>
          </div>
          <div class="table-responsive">
            <table
              id="myTable"
              class="table table-striped table-hover align-middle mb-0"
            >
              <thead class="table-light">
                <tr>
                  <th class="sticky-col sticky-top">åŸå¸‚</th>
                  <th class="sticky-top">èµ°å‹¢</th>
                  <th id="thRange1" class="sticky-top">0â€“12 å°æ™‚</th>
                  <th id="thRange2" class="sticky-top">12â€“24 å°æ™‚</th>
                  <th id="thRange3" class="sticky-top">24â€“36 å°æ™‚</th>
                </tr>
              </thead>
              <tbody id="myTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="weather-footer">
      <p>è³‡æ–™ä¾†æºï¼š<a href="https://opendata.cwa.gov.tw/" target="_blank" rel="noopener">ä¸­å¤®æ°£è±¡ç½²é–‹æ”¾è³‡æ–™å¹³è‡º</a></p>
    </div>

    <!-- è¼‰å…¥bs5 js -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js"
      integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- è¼‰å…¥jquery -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- DataTables JS (éœ€åœ¨ jQuery ä¹‹å¾Œ) -->
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <!-- å·²æ”¹ç”¨ Bootstrap .table-responsiveï¼Œç„¡éœ€ DataTables Responsive JS -->

    <!-- è¼‰å…¥pwd -->
    <!-- .gitignore -->
    <!-- /pw -->
    <!-- /pw/pw.js -->
    <!-- let pw = 'your password' -->
    <script src="pw.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
      $(document).ready(function () {
        // jQuery ç¨‹å¼
        var pwd = typeof pw !== "undefined" ? pw : "";
        var $myTbody = $("#myTbody");

        function getIconFolder(startTime) {
          if (!startTime || startTime.length < 13) return "day";
          var hh = parseInt(startTime.slice(11, 13), 10);
          return hh >= 18 || hh < 6 ? "night" : "day";
        }

        // åœ°å€å°æ‡‰è¡¨
        var regionMap = {
          north: [
            "åŸºéš†å¸‚",
            "æ–°åŒ—å¸‚",
            "è‡ºåŒ—å¸‚",
            "æ¡ƒåœ’å¸‚",
            "æ–°ç«¹å¸‚",
            "æ–°ç«¹ç¸£",
            "å®œè˜­ç¸£",
          ],
          central: ["è‹—æ —ç¸£", "è‡ºä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£"],
          south: ["å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "è‡ºå—å¸‚", "é«˜é›„å¸‚", "å±æ±ç¸£"],
          east: ["èŠ±è“®ç¸£", "è‡ºæ±ç¸£"],
          islands: ["æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"],
        };

        // å¹«åŠ©å‡½å¼ï¼šè½‰ç¾©æ­£è¦è¡¨ç¤ºå¼å­—å…ƒ
        function escapeRegex(str) {
          return String(str).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }

  var tempChart = null;
  var miniCharts = {};
  var locationMap = {};
  var currentSelectedCity = null; // ç•¶å‰åœ¨ä¸‹æ‹‰é¸å–®é¸æ“‡çš„åŸå¸‚

        function createOrUpdateChart(labels, datasets) {
          var ctx = document.getElementById("tempChart").getContext("2d");
          if (tempChart) {
            tempChart.data.labels = labels;
            tempChart.data.datasets = datasets;
            tempChart.update();
            return;
          }
          tempChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: datasets,
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                legend: { position: 'top' },
                tooltip: { enabled: true }
              },
              scales: {
                y: {
                  title: { display: true, text: 'æº«åº¦ (Â°C)' }
                }
              }
            }
          });
        }

        function buildChartDataFromLocation(location) {
          // å›å‚³ labels èˆ‡ datasetsï¼ˆmin/maxï¼‰
          var times = (location && location.weatherElement && location.weatherElement[2] && location.weatherElement[2].time) || [];
          var labels = [];
          var minTemps = [];
          var maxTemps = [];
          for (var i = 0; i < times.length; i++) {
            var t = times[i];
            labels.push((t && t.startTime) ? t.startTime.replace('T', ' ') : '');
            var min = (t && t.parameter && t.parameter.parameterName) || null;
            // å°æ‡‰åˆ° weatherElement[4] çš„ max
            var max = null;
            try {
              max = location.weatherElement[4].time[i].parameter.parameterName;
            } catch (e) {
              max = null;
            }
            minTemps.push(min !== null ? parseFloat(min) : null);
            maxTemps.push(max !== null ? parseFloat(max) : null);
          }

          var datasets = [
            {
              label: 'æœ€ä½æº«',
              data: minTemps,
              borderColor: 'rgba(54,162,235,1)',
              backgroundColor: 'rgba(54,162,235,0.2)',
              tension: 0.3,
            },
            {
              label: 'æœ€é«˜æº«',
              data: maxTemps,
              borderColor: 'rgba(255,99,132,1)',
              backgroundColor: 'rgba(255,99,132,0.2)',
              tension: 0.3,
            }
          ];
          return { labels: labels, datasets: datasets };
        }

        function buildAverageChartData(allData) {
          var ref = allData[0] && allData[0].weatherElement && allData[0].weatherElement[2] && allData[0].weatherElement[2].time || [];
          var avgLabels = [];
          var avgMin = [];
          var avgMax = [];
          for (var i = 0; i < ref.length; i++) {
            avgLabels.push((ref[i] && ref[i].startTime) ? ref[i].startTime.replace('T',' ') : '');
            var sumMin = 0, sumMax = 0, cnt = 0;
            for (var k = 0; k < allData.length; k++) {
              try {
                var mn = parseFloat(allData[k].weatherElement[2].time[i].parameter.parameterName);
                var mx = parseFloat(allData[k].weatherElement[4].time[i].parameter.parameterName);
                if (!isNaN(mn) && !isNaN(mx)) {
                  sumMin += mn; sumMax += mx; cnt++;
                }
              } catch (e) {}
            }
            avgMin.push(cnt>0 ? +(sumMin/cnt).toFixed(1) : null);
            avgMax.push(cnt>0 ? +(sumMax/cnt).toFixed(1) : null);
          }
          var datasets = [
            { label: 'æœ€ä½æº«', data: avgMin, borderColor: 'rgba(54,162,235,1)', backgroundColor: 'rgba(54,162,235,0.2)', tension:0.3 },
            { label: 'æœ€é«˜æº«', data: avgMax, borderColor: 'rgba(255,99,132,1)', backgroundColor: 'rgba(255,99,132,0.2)', tension:0.3 }
          ];
          return { labels: avgLabels, datasets: datasets };
        }

        function updateMainChartForCity(cityName, allData) {
          // cityName falsy => show average
          if (!cityName) {
            if (!allData || allData.length === 0) return;
            var avg = buildAverageChartData(allData);
            createOrUpdateChart(avg.labels, avg.datasets);
            return;
          }
          var loc = locationMap[cityName];
          if (loc) {
            var cd = buildChartDataFromLocation(loc);
            // è¨ˆç®— y ç¯„åœï¼ˆè®“åœ–è¡¨ä¸æœƒå¤ªè²¼é‚Šï¼‰
            var allValues = [].concat(cd.datasets[0].data || [], cd.datasets[1].data || []).filter(function(x){return x!==null});
            var min = Math.min.apply(null, allValues);
            var max = Math.max.apply(null, allValues);
            if (!isFinite(min) || !isFinite(max)) {
              createOrUpdateChart(cd.labels, cd.datasets);
              return;
            }
            var pad = Math.max(1, Math.round((max - min) * 0.1));
            // æ›´æ–° chart ä¸¦è¨­ç½® y è»¸é™åˆ¶
            if (tempChart) {
              tempChart.options.scales = tempChart.options.scales || {};
              tempChart.options.scales.y = tempChart.options.scales.y || {};
              tempChart.options.scales.y.min = Math.floor(min - pad);
              tempChart.options.scales.y.max = Math.ceil(max + pad);
            }
            createOrUpdateChart(cd.labels, cd.datasets);
          }
        }

        function loadData() {
          $("#loading").removeClass("d-none");
          // éŠ·æ¯€å…ˆå‰çš„ mini chartsï¼ˆè‹¥æœ‰ï¼‰ä»¥é¿å…è¨˜æ†¶é«”æ´©æ¼
          try {
            for (var k in miniCharts) {
              if (miniCharts[k] && typeof miniCharts[k].destroy === 'function') {
                miniCharts[k].destroy();
              }
            }
          } catch (e) {
            console.warn('éŠ·æ¯€ miniCharts æ™‚ç™¼ç”ŸéŒ¯èª¤', e);
          }
          miniCharts = {};
          // è‹¥æœªè¨­å®šæˆæ¬Šé‡‘é‘° (pw)ï¼Œé¡¯ç¤ºè­¦å‘Šï¼Œä½†ä»å˜—è©¦å‘¼å« APIï¼ˆé–‹ç™¼æ™‚å¯è§€å¯Ÿå›å‚³ï¼‰
          if (!pwd) {
            $("#lastUpdated").text(
              "è­¦å‘Šï¼šæœªè¨­å®š pwï¼ˆè«‹åœ¨ pw.js å®šç¾©è®Šæ•¸ pwï¼‰ï¼Œå˜—è©¦ç„¡æˆæ¬Šè«‹æ±‚"
            );
            console.warn("pw æœªå®šç¾©ï¼Œå°‡ä»¥ç©ºæˆæ¬Šå‘¼å« APIï¼ˆå¯èƒ½æœƒè¢«æ‹’çµ•ï¼‰");
          }
          if ($.fn.DataTable && $.fn.DataTable.isDataTable("#myTable")) {
            $("#myTable").DataTable().destroy();
          }
          $myTbody.empty();

          var url =
            "https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=" +
            pwd;
          $.getJSON(url, function (response) {
            var data = response.records.location;

            // æ’åºï¼ˆä¿ç•™æ—¢æœ‰é †åºé‚è¼¯ï¼‰
            var cityOrder = [
              "è‡ºåŒ—å¸‚",
              "æ–°åŒ—å¸‚",
              "æ¡ƒåœ’å¸‚",
              "åŸºéš†å¸‚",
              "æ–°ç«¹å¸‚",
              "æ–°ç«¹ç¸£",
              "è‹—æ —ç¸£",
              "è‡ºä¸­å¸‚",
              "å½°åŒ–ç¸£",
              "å—æŠ•ç¸£",
              "é›²æ—ç¸£",
              "å˜‰ç¾©å¸‚",
              "å˜‰ç¾©ç¸£",
              "è‡ºå—å¸‚",
              "é«˜é›„å¸‚",
              "å±æ±ç¸£",
              "å®œè˜­ç¸£",
              "èŠ±è“®ç¸£",
              "è‡ºæ±ç¸£",
              "æ¾æ¹–ç¸£",
              "é‡‘é–€ç¸£",
              "é€£æ±Ÿç¸£",
            ];
            var orderMap = {};
            for (var i = 0; i < cityOrder.length; i++) {
              orderMap[cityOrder[i]] = i;
            }
            data.sort(function (a, b) {
              var ia =
                orderMap[a.locationName] == null
                  ? 999
                  : orderMap[a.locationName];
              var ib =
                orderMap[b.locationName] == null
                  ? 999
                  : orderMap[b.locationName];
              return ia - ib;
            });

            // è¨­å®šä¸‰å€‹æ™‚é–“æ¬„ä½æ¨™é¡Œ
            var times =
              (data[0] &&
                data[0].weatherElement &&
                data[0].weatherElement[2] &&
                data[0].weatherElement[2].time) ||
              [];
            function getRangeText(t) {
              return t ? t.startTime + "â€“" + t.endTime : "";
            }
            $("#thRange1").text(getRangeText(times[0]) || "å€é–“ 1");
            $("#thRange2").text(getRangeText(times[1]) || "å€é–“ 2");
            $("#thRange3").text(getRangeText(times[2]) || "å€é–“ 3");

            // å»ºè¡¨å…§å®¹
            var html = "";
            $.each(data, function (i, value) {
              var wxT12 =
                value.weatherElement[0].time[0].parameter.parameterName;
              var wxT24 =
                value.weatherElement[0].time[1].parameter.parameterName;
              var wxT36 =
                value.weatherElement[0].time[2].parameter.parameterName;

              var start12 = value.weatherElement[0].time[0].startTime;
              var start24 = value.weatherElement[0].time[1].startTime;
              var start36 = value.weatherElement[0].time[2].startTime;
              var folder12 = getIconFolder(start12);
              var folder24 = getIconFolder(start24);
              var folder36 = getIconFolder(start36);

              var wxValue12 =
                value.weatherElement[0].time[0].parameter.parameterValue;
              var wxValue24 =
                value.weatherElement[0].time[1].parameter.parameterValue;
              var wxValue36 =
                value.weatherElement[0].time[2].parameter.parameterValue;

              var minT12 =
                value.weatherElement[2].time[0].parameter.parameterName;
              var minT24 =
                value.weatherElement[2].time[1].parameter.parameterName;
              var minT36 =
                value.weatherElement[2].time[2].parameter.parameterName;

              var maxT12 =
                value.weatherElement[4].time[0].parameter.parameterName;
              var maxT24 =
                value.weatherElement[4].time[1].parameter.parameterName;
              var maxT36 =
                value.weatherElement[4].time[2].parameter.parameterName;

              html +=
                "<tr>" +
                '<td class="sticky-col">' +
                value.locationName +
                "</td>" +
                // èµ°å‹¢æ¬„ä½ï¼šè¿·ä½  canvasï¼Œid ä½¿ç”¨ç´¢å¼•é¿å…ç‰¹æ®Šå­—å…ƒå•é¡Œ
                '<td><canvas id="miniChart-' + i + '" width="180" height="60" aria-label="' +
                value.locationName +
                ' èµ°å‹¢åœ–" role="img"></canvas></td>' +
                '<td><div class="temp-range">' +
                minT12 +
                "-" +
                maxT12 +
                " &deg;C</div>" +
                '<div class="d-flex align-items-center gap-2 mt-1 flex-wrap">' +
                '<img class="weather-icon" src="./' +
                folder12 +
                "/" +
                wxValue12 +
                '.svg" alt="' +
                wxT12 +
                '" loading="lazy" decoding="async">' +
                "<span>" +
                wxT12 +
                "</span>" +
                "</div></td>" +
                '<td><div class="temp-range">' +
                minT24 +
                "-" +
                maxT24 +
                " &deg;C</div>" +
                '<div class="d-flex align-items-center gap-2 mt-1 flex-wrap">' +
                '<img class="weather-icon" src="./' +
                folder24 +
                "/" +
                wxValue24 +
                '.svg" alt="' +
                wxT24 +
                '" loading="lazy" decoding="async">' +
                "<span>" +
                wxT24 +
                "</span>" +
                "</div></td>" +
                '<td><div class="temp-range">' +
                minT36 +
                "-" +
                maxT36 +
                " &deg;C</div>" +
                '<div class="d-flex align-items-center gap-2 mt-1 flex-wrap">' +
                '<img class="weather-icon" src="./' +
                folder36 +
                "/" +
                wxValue36 +
                '.svg" alt="' +
                wxT36 +
                '" loading="lazy" decoding="async">' +
                "<span>" +
                wxT36 +
                "</span>" +
                "</div></td>" +
                "</tr>";
            });

            $myTbody.append(html);

            // è¨­å®š locationMap
            locationMap = {};
            $.each(data, function (i, v) {
              if (v && v.locationName) locationMap[v.locationName] = v;
            });

            // ç‚ºæ¯åˆ—å»ºç«‹ mini chart
            $.each(data, function (i, v) {
              var cid = 'miniChart-' + i;
              var canvas = document.getElementById(cid);
              if (!canvas) return;
              try {
                var cd = buildChartDataFromLocation(v);
                // ç¸®å°ç‰ˆ datasetsï¼ˆä¸é¡¯ç¤ºåœ–ä¾‹ã€å»æ‰é»ï¼‰
                var ds = cd.datasets.map(function(d){
                  return {
                    label: d.label,
                    data: d.data,
                    borderColor: d.borderColor,
                    backgroundColor: d.backgroundColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0.3,
                    fill: false
                  };
                });
                // éŠ·æ¯€å¯èƒ½å·²å­˜åœ¨çš„åœ–è¡¨
                if (miniCharts[cid] && typeof miniCharts[cid].destroy === 'function') {
                  miniCharts[cid].destroy();
                }
                miniCharts[cid] = new Chart(canvas.getContext('2d'), {
                  type: 'line',
                  data: { labels: cd.labels, datasets: ds },
                  options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                  }
                });
                // äº’å‹•ï¼šhover é¡¯ç¤ºæ–¼ä¸»åœ–ï¼ˆæš«æ™‚ï¼‰ï¼Œclick é¸å®šåŸå¸‚
                (function(cityName, cidLocal){
                  var el = document.getElementById(cidLocal);
                  if (!el) return;
                  el.addEventListener('mouseenter', function(){
                    // æš«å­˜ç›®å‰é¸å–
                    try { updateMainChartForCity(cityName, data); } catch(e){}
                  });
                  el.addEventListener('mouseleave', function(){
                    try { updateMainChartForCity(currentSelectedCity, data); } catch(e){}
                  });
                  el.addEventListener('click', function(){
                    try {
                      // è¨­å®šä¸‹æ‹‰ä¸¦è§¸ç™¼ changeï¼Œé€™æœƒæ›´æ–° table èˆ‡ä¸»åœ–
                      $('#citySelect').val(cityName).trigger('change');
                      currentSelectedCity = cityName;
                    } catch(e){}
                  });
                })(v.locationName, cid);
              } catch (e) {
                console.warn('å»ºç«‹ mini chart å¤±æ•— for', cid, e);
              }
            });

            // è¨ˆç®—ä¸¦é¡¯ç¤º KPIï¼ˆå…¨å°å¹³å‡ / ä»Šæ—¥æœ€é«˜ / ä»Šæ—¥æœ€ä½ï¼‰
            try {
              var sumAvg = 0, cntAvg = 0, globalMax = -999, globalMin = 999;
              for (var i = 0; i < data.length; i++) {
                try {
                  var times = data[i].weatherElement[2].time;
                  var maxTimes = data[i].weatherElement[4].time;
                  for (var j = 0; j < times.length; j++) {
                    var mn = parseFloat(times[j].parameter.parameterName);
                    var mx = parseFloat(maxTimes[j].parameter.parameterName);
                    if (!isNaN(mn)) { sumAvg += mn; cntAvg++; globalMin = Math.min(globalMin, mn); }
                    if (!isNaN(mx)) { globalMax = Math.max(globalMax, mx); }
                  }
                } catch (e) {}
              }
              var avgVal = cntAvg>0 ? +(sumAvg/cntAvg).toFixed(1) : 'â€”';
              $('#kpiAvgValue').text((avgVal!=='â€”'?avgVal+' Â°C':'â€”'));
              $('#kpiHighValue').text(globalMax>-900? globalMax+' Â°C':'â€”');
              $('#kpiLowValue').text(globalMin<900? globalMin+' Â°C':'â€”');
            } catch (e) { console.warn('KPI è¨ˆç®—å¤±æ•—', e); }

            // åœ¨è¡Œå‹•è£ç½®å»ºç«‹å¡ç‰‡åˆ—è¡¨ï¼ˆç°¡åŒ–è³‡è¨Šï¼‰
            try {
              var $cardList = $('#cardList');
              $cardList.empty();
              for (var i = 0; i < data.length; i++) {
                var v = data[i];
                var min0 = (v.weatherElement[2].time[0].parameter.parameterName);
                var max0 = (v.weatherElement[4].time[0].parameter.parameterName);
                var $card = $("<div class='kpi' tabindex='0'>")
                  .append($('<div>').addClass('label').text(v.locationName))
                  .append($('<div>').addClass('value').text(min0 + ' - ' + max0 + ' Â°C'))
                  .append($('<div>').addClass('mt-2').append(
                    $('<button type="button">').addClass('btn btn-sm btn-outline-primary').text('æŸ¥çœ‹èµ°å‹¢').on('click', (function(city){ return function(){ $('#citySelect').val(city).trigger('change'); };})(v.locationName))
                  ));
                $cardList.append($card);
              }
            } catch (e) { console.warn('å»ºç«‹è¡Œå‹•å¡ç‰‡å¤±æ•—', e); }

            // è‹¥æœ‰è‡³å°‘ä¸€å€‹åŸå¸‚ï¼Œé è¨­é¡¯ç¤ºç¬¬ä¸€å€‹åŸå¸‚åœ–è¡¨ï¼›ç©ºå€¼ä»£è¡¨å…¨å°å¹³å‡
            var defaultLoc = data[0] || null;
            if (defaultLoc) {
              var cd = buildChartDataFromLocation(defaultLoc);
              createOrUpdateChart(cd.labels, cd.datasets);
            }

            // åˆå§‹åŒ– DataTable
            var table = $("#myTable").DataTable({
              language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/zh-HANT.json",
              },
              pageLength: 25,
              lengthMenu: [10, 25, 50, 100],
              order: [],
              deferRender: true,
              dom: "frtip",
            });

            // å–å¾—ä¸é‡è¤‡çš„åŸå¸‚åˆ—è¡¨
            var allCities = [];
            $.each(data, function (i, v) {
              if (
                v.locationName &&
                $.inArray(v.locationName, allCities) === -1
              ) {
                allCities.push(v.locationName);
              }
            });

            // å¡«å…¥ citySelect
            var $citySelect = $("#citySelect");
            if ($citySelect.children("option").length === 1) {
              $.each(allCities, function (i, c) {
                $citySelect.append($("<option>").val(c).text(c));
              });
            }

            // ç”¢ç”Ÿå¿«é€ŸæŒ‰éˆ•ï¼ˆç†±é–€åŸå¸‚ï¼‰
            function createQuickButtons(list) {
              var $q = $("#quickCityButtons");
              $q.empty();
              for (var i = 0; i < Math.min(6, list.length); i++) {
                (function (city) {
                  var $b = $('<button type="button">')
                    .addClass("btn btn-sm btn-outline-primary me-1 mb-1")
                    .text(city);
                  $b.on("click", function () {
                    $citySelect.val(city).trigger("change");
                  });
                  $q.append($b);
                })(list[i]);
              }
            }

            // åˆå§‹ quick buttonsï¼ˆå…¨éƒ¨åŸå¸‚å‰ 6 å€‹ï¼‰
            createQuickButtons(allCities);

            // æ ¹æ“šåœ°å€å¡«å…¥åŸå¸‚ï¼ˆæ›´å®¹éŒ¯ï¼‰ï¼šå„ªå…ˆä½¿ç”¨æ­£è¦åŒ–çš„ç²¾æº–åŒ¹é…ï¼Œè‹¥ç„¡çµæœå‰‡ä»¥ substring fallback
            $("#regionSelect")
              .off("change")
              .on("change", function () {
                var region = $(this).val();
                $citySelect
                  .empty()
                  .append($("<option>").val("").text("å…¨éƒ¨åŸå¸‚"));
                var list = [];
                if (!region) {
                  list = allCities.slice();
                } else {
                  var rlist = regionMap[region] || [];
                  function norm(s) {
                    return String(s || "")
                      .replace(/\s+/g, "")
                      .trim();
                  }
                  var rnorm = rlist.map(norm);
                  // æ­£è¦åŒ–ç²¾æº–åŒ¹é…
                  for (var i = 0; i < allCities.length; i++) {
                    if (rnorm.indexOf(norm(allCities[i])) !== -1)
                      list.push(allCities[i]);
                  }
                  // fallback: è‹¥æ²’æœ‰ä»»ä½•åŒ¹é…ï¼Œä½¿ç”¨ substring æª¢æŸ¥
                  if (list.length === 0) {
                    for (var i = 0; i < allCities.length; i++) {
                      for (var k = 0; k < rlist.length; k++) {
                        if (
                          allCities[i].indexOf(rlist[k]) !== -1 ||
                          rlist[k].indexOf(allCities[i]) !== -1
                        ) {
                          if ($.inArray(allCities[i], list) === -1)
                            list.push(allCities[i]);
                        }
                      }
                    }
                  }
                }
                // æ’åºä¸¦å¡«å…¥
                list.sort();
                for (var j = 0; j < list.length; j++) {
                  $citySelect.append($("<option>").val(list[j]).text(list[j]));
                }
                createQuickButtons(list);
              });

            // citySelect change -> ç¯©é¸è¡¨æ ¼ï¼ˆç¬¬ä¸€æ¬„åŸå¸‚ï¼‰
            $citySelect.off("change").on("change", function () {
              var val = $(this).val();
              currentSelectedCity = val || null;
              if (!val) {
                table.column(0).search("").draw();
                // é¡¯ç¤ºå…¨å°å¹³å‡ï¼ˆå°‡ä¸‰å€‹æ™‚æ®µå¹³å‡åŒ–ï¼‰
                updateMainChartForCity(null, data);
              } else {
                table
                  .column(0)
                  .search("^" + escapeRegex(val) + "$", true, false)
                  .draw();
                // é¡¯ç¤ºè©²åŸå¸‚åœ–è¡¨
                updateMainChartForCity(val, data);
              }
            });
          })
            .fail(function (jqxhr, textStatus, error) {
              $("#loading").addClass("d-none");
              $("#lastUpdated").text("API è«‹æ±‚å¤±æ•—ï¼š" + (textStatus || error));
              console.error("API è¯·æ±‚å¤±è´¥:", textStatus, error, jqxhr);
            })
            .always(function () {
              $("#loading").addClass("d-none");
              $("#lastUpdated").text(new Date().toLocaleString());
            });
        }

        // é¦–æ¬¡è¼‰å…¥ä¸¦ç¶å®šé‡æ–°è¼‰å…¥æŒ‰éˆ•
        loadData();
        $("#btnReload").on("click", loadData);
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- è¼‰å…¥bs5 css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css"
      integrity="sha512-fw7f+TcMjTb7bpbLJZlP8g2Y4XcCyFZW8uy8HsRZsH/SwbMw0plKHFHr99DN3l04VsYNwvzicUX/6qurvIxbxw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    
  </head>

  <body>
    <div class="container py-4">
      <div class="mb-3" id="slot-wrapper" style="display: none">
        <label for="slot-select" class="form-label mb-1">é¸æ“‡æ™‚æ®µ</label>
        <select id="slot-select" class="form-select form-select-sm"></select>
      </div>

      <!-- ç‹€æ…‹/éŒ¯èª¤è¨Šæ¯é¡¯ç¤º -->
      <div id="status" aria-live="polite"></div>

      <!-- å¡ç‰‡ç¶²æ ¼ï¼šæ¯å€‹åœ°å€ä¸€å¼µå¡ç‰‡ï¼Œé¡¯ç¤ºå¤©æ°£ã€æº«åº¦ã€é™é›¨ç­‰ï¼ˆè‡ªå‹•è¼‰å…¥ï¼‰ -->
      <div class="row g-3 mt-2" id="card-grid">
        <div class="col-12 text-muted">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>
      </div>
    </div>

  <!-- æœ¬é æœªä½¿ç”¨ Bootstrap JS å…ƒä»¶ï¼Œçœç•¥è¼‰å…¥å¯æ¸›å°‘æµé‡èˆ‡é˜»å¡ -->

    <!-- è¼‰å…¥jqueryï¼ˆæœ¬é ç”¨ jQuery ä¾†å‘¼å« API èˆ‡æ›´æ–°ç•«é¢ï¼‰ -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- æœ¬æ©Ÿé‡‘é‘°è¨­å®šï¼ˆè«‹è¤‡è£½ config.example.js ç‚º config.local.js ä¸¦å¡«å…¥é‡‘é‘°ï¼›æ­¤æª”å·²åœ¨ .gitignore ä¸­ï¼‰ -->
    <script src="config.local.js"></script>
    <script>
      // ç›®æ¨™ï¼šè‡ªå‹•æ“·å–ä¸­å¤®æ°£è±¡ç½² JSONï¼Œæ•´ç†å¾Œä»¥ã€Œå¡ç‰‡ã€ç¾åŒ–é¡¯ç¤º
      // é‡é»ï¼š
      // 1) ä½¿ç”¨ $.ajax å–å¾—è³‡æ–™ï¼ˆéæœ¬åœ°æª”ï¼‰
      // 2) è§£æ records.location é™£åˆ—ï¼Œå–å‡º Wx/PoP/MinT/MaxT/CI ç­‰æ¬„ä½
      // 3) ä»¥ Bootstrap Card å‘ˆç¾ï¼Œä¸¦å¯åˆ‡æ› 3 å€‹æ™‚æ®µ

      $(function () {
        // è®€å–æœ¬æ©Ÿæœªæäº¤çš„ API URLï¼ˆwindow.CONFIG ç”± config.local.js æä¾›ï¼‰
        var API_URL = (window.CONFIG && window.CONFIG.API_URL) || '';
        // è‹¥æœªè¨­å®š URLï¼Œé¡¯ç¤ºæŒ‡ç¤ºä¸¦ä¸­æ­¢
        if (!API_URL || /è«‹å¡«å…¥/.test(API_URL)) {
          $('#status').html('<div class="alert alert-warning py-2 mb-2">' +
            'å°šæœªè¨­å®š API URLã€‚è«‹å°‡ <code>config.example.js</code> è¤‡è£½ç‚º <code>config.local.js</code>ï¼Œä¸¦å¡«å…¥ <code>window.CONFIG.API_URL</code>ï¼ˆå¯åŒ…å«é‡‘é‘°çš„æŸ¥è©¢åƒæ•¸ï¼‰ã€‚æ­¤æª”å·²è¢« <code>.gitignore</code> å¿½ç•¥ï¼Œä¸æœƒä¸Šå‚³åˆ° GitHubã€‚' +
          '</div>');
          return;
        }
        var cached = null; // æš«å­˜ API å›å‚³ï¼Œåˆ‡æ›æ™‚æ®µæ™‚ä¸ç”¨é‡æŠ“

        // é é¢è¼‰å…¥å³è‡ªå‹•æ“·å–ï¼ˆä¸éœ€æŒ‰éˆ•èˆ‡æˆåŠŸæç¤ºï¼‰
        autoFetch();

        // é¸æ“‡æ™‚æ®µå¾Œé‡ç•«å¡ç‰‡
        $("#slot-select").on("change", function () {
          renderCards();
        });

        function autoFetch() {
          // æ¸…ç©ºç‹€æ…‹èˆ‡å¡ç‰‡å€
          $("#status").empty();
          $('#card-grid').html('<div class="col-12 text-muted">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>');

          $.ajax({
            url: API_URL,
            method: "GET",
            dataType: "json",
            timeout: 15000,
          })
            .done(function (data) {
              cached = data;
              // 1) æ¨æ–· 3 å€‹æ™‚æ®µæ¨™ç±¤
              var labels = inferSlots(cached);
              // 2) å¯«å…¥ä¸‹æ‹‰ä¾›åˆ‡æ›
              populateSlotSelect(labels);
              // 3) ä¾ç›®å‰æ™‚æ®µæ¸²æŸ“å¡ç‰‡
              renderCards();
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
              var msg =
                textStatus === "timeout"
                  ? "è«‹æ±‚é€¾æ™‚"
                  : jqXHR.status
                  ? "HTTP " + jqXHR.status + " " + jqXHR.statusText
                  : errorThrown || textStatus;
              showError("æ“·å–å¤±æ•—ï¼š" + msg + "ï¼ˆå¯èƒ½æ˜¯ CORS æˆ–ç¶²è·¯å•é¡Œï¼‰");
            });
        }

        // ä¾è³‡æ–™æ¨å‡º 0~2 æ™‚æ®µçš„æ¨™ç±¤ï¼ˆstartTime ~ endTimeï¼‰
        function inferSlots(data) {
          try {
            var loc0 =
              data &&
              data.records &&
              data.records.location &&
              data.records.location[0];
            var times =
              (loc0 &&
                loc0.weatherElement &&
                loc0.weatherElement[0] &&
                loc0.weatherElement[0].time) ||
              [];
            return times.map(function (t) {
              return t.startTime + " ~ " + t.endTime;
            });
          } catch (e) {
            return [];
          }
        }

        // å°‡æ™‚æ®µå¯«å…¥ä¸‹æ‹‰ï¼Œä¸¦é¡¯ç¤º/éš±è—å®¹å™¨
        function populateSlotSelect(labels) {
          var $wrap = $("#slot-wrapper");
          var $sel = $("#slot-select");
          $sel.empty();
          if (!labels || !labels.length) {
            $wrap.hide();
            return;
          }
          labels.forEach(function (label, idx) {
            $sel.append(
              '<option value="' + idx + '">' + escapeHtml(label) + "</option>"
            );
          });
          $wrap.show();
        }

        // ç”¢ç”Ÿå¡ç‰‡å…§å®¹ï¼ˆæ¯å€‹åœ°å€ä¸€å¼µå¡ï¼‰
        function renderCards() {
          var $grid = $("#card-grid");
          $grid.empty();

          var locations = cached && cached.records && cached.records.location;
          if (!Array.isArray(locations)) {
            $grid.append(
              '<div class="col-12 text-muted">ç„¡æ³•è§£æè³‡æ–™æ ¼å¼</div>'
            );
            return;
          }

          // ç›®å‰æ‰€é¸æ™‚æ®µç´¢å¼•ï¼ˆ0/1/2ï¼‰
          var idx = parseInt($("#slot-select").val() || "0", 10) || 0;

          locations.forEach(function (loc) {
            // 1) å–å‡ºéœ€è¦çš„æ¬„ä½
            var name = loc.locationName || "-";
            var wxDesc = getParam(loc, "Wx", idx, "parameterName") || "-";
            var wxCode = getParam(loc, "Wx", idx, "parameterValue"); // å¯èƒ½ç‚º undefined
            var pop = getParam(loc, "PoP", idx, "parameterName");
            var minT = getParam(loc, "MinT", idx, "parameterName");
            var maxT = getParam(loc, "MaxT", idx, "parameterName");
            var ci = getParam(loc, "CI", idx, "parameterName") || "-";
            var t = getTime(loc, "Wx", idx) || {};

            // 2) åŸºæ–¼æè¿°/ä»£ç¢¼é¸æ“‡è¡¨æƒ…ç¬¦è™Ÿï¼ˆä¸ä¾è³´å¤–éƒ¨åœ–åº«ï¼‰
            var emoji = pickWeatherEmoji(wxDesc, wxCode);

            // 3) å°è£é¡¯ç¤ºå­—ä¸²
            var timeHtml =
              escapeHtml(t.startTime || "") +
              '<br><small class="text-muted">ã€œ ' +
              escapeHtml(t.endTime || "") +
              "</small>";
            var popText =
              pop !== undefined && pop !== null && pop !== "" ? pop + "%" : "-";
            var minText = minT ? minT + "Â°C" : "-";
            var maxText = maxT ? maxT + "Â°C" : "-";

            // 4) ç”Ÿæˆå¡ç‰‡ HTML
            var card =
              "" +
              '<div class="col-12 col-md-6 col-lg-4">' +
              '<div class="card h-100 shadow-sm">' +
              '<div class="card-body">' +
              '<div class="d-flex align-items-center mb-2">' +
              '<div class="display-6 me-2" aria-hidden="true">' +
              emoji +
              "</div>" + // åœ–ç¤º
              "<div>" +
              '<h5 class="card-title mb-0">' +
              escapeHtml(name) +
              "</h5>" + // åœ°å€
              '<div class="card-subtitle text-muted small">' +
              timeHtml +
              "</div>" + // æ™‚æ®µ
              "</div>" +
              "</div>" +
              '<p class="mb-3"><strong>å¤©æ°£ï¼š</strong>' +
              escapeHtml(wxDesc) +
              "</p>" + // å¤©æ°£æ–‡å­—
              '<div class="d-flex flex-wrap gap-2">' +
              '<span class="badge text-bg-info">é™é›¨ ' +
              escapeHtml(popText) +
              "</span>" +
              '<span class="badge text-bg-success">æœ€ä½ ' +
              escapeHtml(minText) +
              "</span>" +
              '<span class="badge text-bg-danger">æœ€é«˜ ' +
              escapeHtml(maxText) +
              "</span>" +
              '<span class="badge text-bg-secondary">' +
              escapeHtml(ci) +
              "</span>" +
              "</div>" +
              "</div>" +
              "</div>" +
              "</div>";

            $grid.append(card);
          });
        }

        // å–æŸå…ƒç´ åœ¨æŒ‡å®šæ™‚æ®µçš„åƒæ•¸å€¼ï¼ˆparameter.parameterName / parameter.parameterValueï¼‰
        function getParam(loc, elementName, idx, key) {
          var el = (loc.weatherElement || []).find(function (e) {
            return e.elementName === elementName;
          });
          var item = el && el.time && el.time[idx];
          var val = item && item.parameter && item.parameter[key];
          return val === undefined ? null : val;
        }

        // å–å¾—æŸå…ƒç´ åœ¨æŒ‡å®šæ™‚æ®µçš„æ™‚é–“å€é–“
        function getTime(loc, elementName, idx) {
          var el = (loc.weatherElement || []).find(function (e) {
            return e.elementName === elementName;
          });
          return (el && el.time && el.time[idx]) || null;
        }

        // åƒ…åœ¨å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
          $("#status").html(
            '<div class="alert alert-danger py-2 mb-0">' +
              escapeHtml(message) +
              "</div>"
          );
        }

        // è½‰ç¾©æ–‡å­—é¿å…æ’å…¥ HTMLï¼ˆåŸºæœ¬ XSS é˜²è­·ï¼‰
        function escapeHtml(text) {
          var div = document.createElement("div");
          div.textContent = String(text == null ? "" : text);
          return div.innerHTML;
        }

        // ä¾ Wx æè¿°/ä»£ç¢¼æŒ‘é¸åˆé©è¡¨æƒ…ç¬¦è™Ÿï¼ˆç°¡å–®è¦å‰‡ç‰ˆï¼‰
        function pickWeatherEmoji(desc, code) {
          desc = String(desc || "");
          // é—œéµå­—å„ªå…ˆï¼ˆä¸­æ–‡é—œéµå­—ï¼šé›·ã€é›¨ã€é›ªã€é™°ã€å¤šé›²ã€æ™´ï¼‰
          if (/é›·/.test(desc)) return "â›ˆï¸";
          if (/é›ª/.test(desc)) return "ğŸŒ¨ï¸";
          if (/é›¨/.test(desc)) return "ğŸŒ§ï¸";
          if (/é™°/.test(desc)) return "â˜ï¸";
          if (/å¤šé›²/.test(desc)) return "â›…";
          if (/æ™´/.test(desc)) return "â˜€ï¸";
          // è‹¥ç„¡æ³•åˆ¤æ–·ï¼Œç”¨ä»£ç¢¼åšç²—ç•¥å°æ‡‰
          var num = parseInt(code, 10);
          if (!isNaN(num)) {
            if (num >= 20 && num <= 24) return "â›ˆï¸"; // é›·é™£é›¨æ—ç¾¤
            if (num >= 8 && num <= 19) return "ğŸŒ§ï¸"; // é™£é›¨/é›¨
            if (num === 4) return "â˜ï¸"; // å¤šé›²
            if (num === 2 || num === 3) return "â›…"; // æ™´æ™‚å¤šé›²/å¤šé›²æ™‚æ™´
            if (num === 1) return "â˜€ï¸"; // æ™´
          }
          return "ğŸŒ¤ï¸"; // é è¨­
        }

      });
    </script>
  </body>
</html>

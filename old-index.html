<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- 載入bs5 css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css"
      integrity="sha512-fw7f+TcMjTb7bpbLJZlP8g2Y4XcCyFZW8uy8HsRZsH/SwbMw0plKHFHr99DN3l04VsYNwvzicUX/6qurvIxbxw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    
  </head>

  <body>
    <div class="container py-4">
      <div class="mb-3" id="slot-wrapper" style="display: none">
        <label for="slot-select" class="form-label mb-1">選擇時段</label>
        <select id="slot-select" class="form-select form-select-sm"></select>
      </div>

      <!-- 狀態/錯誤訊息顯示 -->
      <div id="status" aria-live="polite"></div>

      <!-- 卡片網格：每個地區一張卡片，顯示天氣、溫度、降雨等（自動載入） -->
      <div class="row g-3 mt-2" id="card-grid">
        <div class="col-12 text-muted">資料載入中…</div>
      </div>
    </div>

  <!-- 本頁未使用 Bootstrap JS 元件，省略載入可減少流量與阻塞 -->

    <!-- 載入jquery（本頁用 jQuery 來呼叫 API 與更新畫面） -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- 本機金鑰設定（請複製 config.example.js 為 config.local.js 並填入金鑰；此檔已在 .gitignore 中） -->
    <script src="config.local.js"></script>
    <script>
      // 目標：自動擷取中央氣象署 JSON，整理後以「卡片」美化顯示
      // 重點：
      // 1) 使用 $.ajax 取得資料（非本地檔）
      // 2) 解析 records.location 陣列，取出 Wx/PoP/MinT/MaxT/CI 等欄位
      // 3) 以 Bootstrap Card 呈現，並可切換 3 個時段

      $(function () {
        // 讀取本機未提交的 API URL（window.CONFIG 由 config.local.js 提供）
        var API_URL = (window.CONFIG && window.CONFIG.API_URL) || '';
        // 若未設定 URL，顯示指示並中止
        if (!API_URL || /請填入/.test(API_URL)) {
          $('#status').html('<div class="alert alert-warning py-2 mb-2">' +
            '尚未設定 API URL。請將 <code>config.example.js</code> 複製為 <code>config.local.js</code>，並填入 <code>window.CONFIG.API_URL</code>（可包含金鑰的查詢參數）。此檔已被 <code>.gitignore</code> 忽略，不會上傳到 GitHub。' +
          '</div>');
          return;
        }
        var cached = null; // 暫存 API 回傳，切換時段時不用重抓

        // 頁面載入即自動擷取（不需按鈕與成功提示）
        autoFetch();

        // 選擇時段後重畫卡片
        $("#slot-select").on("change", function () {
          renderCards();
        });

        function autoFetch() {
          // 清空狀態與卡片區
          $("#status").empty();
          $('#card-grid').html('<div class="col-12 text-muted">資料載入中…</div>');

          $.ajax({
            url: API_URL,
            method: "GET",
            dataType: "json",
            timeout: 15000,
          })
            .done(function (data) {
              cached = data;
              // 1) 推斷 3 個時段標籤
              var labels = inferSlots(cached);
              // 2) 寫入下拉供切換
              populateSlotSelect(labels);
              // 3) 依目前時段渲染卡片
              renderCards();
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
              var msg =
                textStatus === "timeout"
                  ? "請求逾時"
                  : jqXHR.status
                  ? "HTTP " + jqXHR.status + " " + jqXHR.statusText
                  : errorThrown || textStatus;
              showError("擷取失敗：" + msg + "（可能是 CORS 或網路問題）");
            });
        }

        // 依資料推出 0~2 時段的標籤（startTime ~ endTime）
        function inferSlots(data) {
          try {
            var loc0 =
              data &&
              data.records &&
              data.records.location &&
              data.records.location[0];
            var times =
              (loc0 &&
                loc0.weatherElement &&
                loc0.weatherElement[0] &&
                loc0.weatherElement[0].time) ||
              [];
            return times.map(function (t) {
              return t.startTime + " ~ " + t.endTime;
            });
          } catch (e) {
            return [];
          }
        }

        // 將時段寫入下拉，並顯示/隱藏容器
        function populateSlotSelect(labels) {
          var $wrap = $("#slot-wrapper");
          var $sel = $("#slot-select");
          $sel.empty();
          if (!labels || !labels.length) {
            $wrap.hide();
            return;
          }
          labels.forEach(function (label, idx) {
            $sel.append(
              '<option value="' + idx + '">' + escapeHtml(label) + "</option>"
            );
          });
          $wrap.show();
        }

        // 產生卡片內容（每個地區一張卡）
        function renderCards() {
          var $grid = $("#card-grid");
          $grid.empty();

          var locations = cached && cached.records && cached.records.location;
          if (!Array.isArray(locations)) {
            $grid.append(
              '<div class="col-12 text-muted">無法解析資料格式</div>'
            );
            return;
          }

          // 目前所選時段索引（0/1/2）
          var idx = parseInt($("#slot-select").val() || "0", 10) || 0;

          locations.forEach(function (loc) {
            // 1) 取出需要的欄位
            var name = loc.locationName || "-";
            var wxDesc = getParam(loc, "Wx", idx, "parameterName") || "-";
            var wxCode = getParam(loc, "Wx", idx, "parameterValue"); // 可能為 undefined
            var pop = getParam(loc, "PoP", idx, "parameterName");
            var minT = getParam(loc, "MinT", idx, "parameterName");
            var maxT = getParam(loc, "MaxT", idx, "parameterName");
            var ci = getParam(loc, "CI", idx, "parameterName") || "-";
            var t = getTime(loc, "Wx", idx) || {};

            // 2) 基於描述/代碼選擇表情符號（不依賴外部圖庫）
            var emoji = pickWeatherEmoji(wxDesc, wxCode);

            // 3) 封裝顯示字串
            var timeHtml =
              escapeHtml(t.startTime || "") +
              '<br><small class="text-muted">〜 ' +
              escapeHtml(t.endTime || "") +
              "</small>";
            var popText =
              pop !== undefined && pop !== null && pop !== "" ? pop + "%" : "-";
            var minText = minT ? minT + "°C" : "-";
            var maxText = maxT ? maxT + "°C" : "-";

            // 4) 生成卡片 HTML
            var card =
              "" +
              '<div class="col-12 col-md-6 col-lg-4">' +
              '<div class="card h-100 shadow-sm">' +
              '<div class="card-body">' +
              '<div class="d-flex align-items-center mb-2">' +
              '<div class="display-6 me-2" aria-hidden="true">' +
              emoji +
              "</div>" + // 圖示
              "<div>" +
              '<h5 class="card-title mb-0">' +
              escapeHtml(name) +
              "</h5>" + // 地區
              '<div class="card-subtitle text-muted small">' +
              timeHtml +
              "</div>" + // 時段
              "</div>" +
              "</div>" +
              '<p class="mb-3"><strong>天氣：</strong>' +
              escapeHtml(wxDesc) +
              "</p>" + // 天氣文字
              '<div class="d-flex flex-wrap gap-2">' +
              '<span class="badge text-bg-info">降雨 ' +
              escapeHtml(popText) +
              "</span>" +
              '<span class="badge text-bg-success">最低 ' +
              escapeHtml(minText) +
              "</span>" +
              '<span class="badge text-bg-danger">最高 ' +
              escapeHtml(maxText) +
              "</span>" +
              '<span class="badge text-bg-secondary">' +
              escapeHtml(ci) +
              "</span>" +
              "</div>" +
              "</div>" +
              "</div>" +
              "</div>";

            $grid.append(card);
          });
        }

        // 取某元素在指定時段的參數值（parameter.parameterName / parameter.parameterValue）
        function getParam(loc, elementName, idx, key) {
          var el = (loc.weatherElement || []).find(function (e) {
            return e.elementName === elementName;
          });
          var item = el && el.time && el.time[idx];
          var val = item && item.parameter && item.parameter[key];
          return val === undefined ? null : val;
        }

        // 取得某元素在指定時段的時間區間
        function getTime(loc, elementName, idx) {
          var el = (loc.weatherElement || []).find(function (e) {
            return e.elementName === elementName;
          });
          return (el && el.time && el.time[idx]) || null;
        }

        // 僅在失敗時顯示錯誤
        function showError(message) {
          $("#status").html(
            '<div class="alert alert-danger py-2 mb-0">' +
              escapeHtml(message) +
              "</div>"
          );
        }

        // 轉義文字避免插入 HTML（基本 XSS 防護）
        function escapeHtml(text) {
          var div = document.createElement("div");
          div.textContent = String(text == null ? "" : text);
          return div.innerHTML;
        }

        // 依 Wx 描述/代碼挑選合適表情符號（簡單規則版）
        function pickWeatherEmoji(desc, code) {
          desc = String(desc || "");
          // 關鍵字優先（中文關鍵字：雷、雨、雪、陰、多雲、晴）
          if (/雷/.test(desc)) return "⛈️";
          if (/雪/.test(desc)) return "🌨️";
          if (/雨/.test(desc)) return "🌧️";
          if (/陰/.test(desc)) return "☁️";
          if (/多雲/.test(desc)) return "⛅";
          if (/晴/.test(desc)) return "☀️";
          // 若無法判斷，用代碼做粗略對應
          var num = parseInt(code, 10);
          if (!isNaN(num)) {
            if (num >= 20 && num <= 24) return "⛈️"; // 雷陣雨族群
            if (num >= 8 && num <= 19) return "🌧️"; // 陣雨/雨
            if (num === 4) return "☁️"; // 多雲
            if (num === 2 || num === 3) return "⛅"; // 晴時多雲/多雲時晴
            if (num === 1) return "☀️"; // 晴
          }
          return "🌤️"; // 預設
        }

      });
    </script>
  </body>
</html>
